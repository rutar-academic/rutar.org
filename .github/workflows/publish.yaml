name: Build Zola Site

on:
  push:
  schedule:
    - cron: '30 10 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.4'
      - name: Install dependencies
        run: python -m pip install --upgrade pip setuptools wheel jinja2 html5validator mathbib
      - name: Download papers
        run: python runner.py papers
        env:
          GITHUB_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
      - name: Download notes
        run: python runner.py notes
        env:
          GITHUB_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
      - name: Generate CV .tex from template
        run: python build_cv.py
      - name: Generate CV .bib
        run: mbib generate build/alex_rutar_cv.tex --out build/alex_rutar_cv.bib
      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v2
        with:
          work_in_root_file_dir: true
          root_file: "build/alex_rutar_cv.tex"
          post_compile: mv "build/alex_rutar_cv.pdf" "static/"
      - name: Build public HTML with drafts
        uses: shalzz/zola-deploy-action@v0.17.2
        if: github.ref != 'refs/heads/master'
        env:
          BUILD_FLAGS: --drafts
          BUILD_ONLY: true
      - name: Build public HTML
        uses: shalzz/zola-deploy-action@v0.17.2
        if: github.ref == 'refs/heads/master'
        env:
          BUILD_ONLY: true
      - name: Check HTML and CSS
        run: html5validator --root public/ --also-check-css --show-warnings
      - name: Publish to Cloudflare
        uses: cloudflare/wrangler-action@2.0.0
        with:
          command: pages publish public "--project-name=rutar" "--branch=${{ github.ref_name }}"
          apiToken: ${{ secrets.CF_API_TOKEN }}
